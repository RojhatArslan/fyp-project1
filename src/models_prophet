import pandas as pd
from pathlib import Path

from prophet import Prophet
from sklearn.metrics import mean_absolute_error, mean_squared_error, r2_score


def train_prophet(data_path: Path): #Train and evaluate a Prophet time-series model using a time-based train/test split.
    
  


    df = pd.read_csv(data_path, parse_dates=["ds"])
    df = df.sort_values("ds").reset_index(drop=True)

 
    prophet_df = df[["ds", "bookings"]].rename(columns={"bookings": "y"})     # Prophet requires only two columns: ds (date) and y (target)

    # Time-based split (80% train, 20% test)
    split_idx = int(len(prophet_df) * 0.8)
    train_df = prophet_df.iloc[:split_idx]
    test_df = prophet_df.iloc[split_idx:]


    model = Prophet(   # Define Prophet model
        yearly_seasonality=True,
        weekly_seasonality=True,
        daily_seasonality=False
    )

    # Train model
    model.fit(train_df)


    future = model.make_future_dataframe(periods=len(test_df), freq="D")   # Create future dataframe for test period

    
    forecast = model.predict(future)


    y_pred = forecast["yhat"].iloc[-len(test_df):].values 
    # Extract predictions corresponding to test period
    y_test = test_df["y"].values

    mae = mean_absolute_error(y_test, y_pred)
    rmse = mean_squared_error(y_test, y_pred, squared=False)
    r2 = r2_score(y_test, y_pred)

    print("Prophet Results")
    print(f"MAE:  {mae:.2f}")
    print(f"RMSE: {rmse:.2f}")
    print(f"RÂ²:   {r2:.3f}")

    return {
        "model": "Prophet",
        "MAE": mae,
        "RMSE": rmse,
        "R2": r2,
    }


if __name__ == "__main__":
    DATA = Path("data/processed/daily_features.csv")
    train_prophet(DATA)
