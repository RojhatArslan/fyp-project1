<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Demand Forecast</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
            padding: 24px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        .header {
            background: #2d3748;
            color: white;
            padding: 24px;
            text-align: center;
        }
        .header h1 { font-size: 1.5rem; font-weight: 600; }
        .header p { opacity: 0.9; font-size: 0.95rem; margin-top: 4px; }
        .header .data-explainer { font-size: 0.8rem; margin-top: 10px; opacity: 0.85; max-width: 640px; margin-left: auto; margin-right: auto; }
        .header .data-explainer code { background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 4px; font-size: 0.85em; }
        .content { padding: 28px; }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 140px auto;
            gap: 16px;
            align-items: end;
            margin-bottom: 24px;
        }
        label { display: block; font-weight: 600; color: #374151; font-size: 0.875rem; margin-bottom: 6px; }
        input[type="date"], input[type="number"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 15px;
        }
        input:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(79,70,229,0.2); }
        button {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }
        button:hover { background: #4338ca; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .loading { text-align: center; padding: 16px; color: #6b7280; display: none; }
        .error { background: #fef2f2; color: #b91c1c; padding: 12px; border-radius: 8px; margin-bottom: 16px; display: none; }
        .results { display: none; margin-top: 24px; }
        .results h2 { font-size: 1.15rem; color: #111827; margin-bottom: 16px; }
        .daily-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 28px;
        }
        .day-card {
            background: #f9fafb;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e5e7eb;
        }
        .day-card .date { font-size: 0.75rem; color: #6b7280; margin-bottom: 4px; }
        .day-card .bookings { font-size: 1.25rem; font-weight: 700; color: #111827; }
        .day-card .guests { font-size: 0.8rem; color: #6b7280; margin-top: 2px; }
        .chart-section {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 24px;
        }
        .chart-section h3 { font-size: 1rem; color: #374151; margin-bottom: 6px; }
        .chart-section .section-note { font-size: 0.8rem; color: #6b7280; margin-bottom: 12px; }
        .key-times-by-day { display: flex; flex-direction: column; gap: 16px; }
        .key-times-day-block {
            background: white;
            padding: 14px 16px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        .key-times-day-block .day-title { font-size: 0.9rem; font-weight: 600; color: #374151; margin-bottom: 10px; }
        .key-times {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
        }
        .key-time {
            background: #f9fafb;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }
        .key-time .label { font-size: 0.75rem; color: #6b7280; }
        .key-time .value { font-size: 1rem; font-weight: 700; color: #4f46e5; }
        .key-time .guests { font-size: 0.7rem; color: #6b7280; margin-top: 2px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Restaurant Demand Forecast</h1>
            <p>Compare forecast with same period last year</p>
            <p class="data-explainer">Numbers = <strong>expected bookings and head count (guests)</strong> from your historical data. Forecast depends on <strong>day of week and month</strong> — change the start date to see different numbers. Source: <code>data/processed/daily_bookings.csv</code>.</p>
        </div>
        <div class="content">
            <form id="predictionForm">
                <div class="form-row">
                    <div>
                        <label for="startDate">Start date</label>
                        <input type="date" id="startDate" name="startDate" required>
                    </div>
                    <div>
                        <label for="horizonDays">Days ahead</label>
                        <input type="number" id="horizonDays" name="horizonDays" min="1" max="14" value="7" required>
                    </div>
                    <button type="submit" id="submitBtn">Generate forecast</button>
                </div>
            </form>
            <div class="loading" id="loading">Generating forecast…</div>
            <div class="error" id="error"></div>
            <div class="results" id="results"></div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const API_URL = window.location.origin;
        let comparisonChart = null;
        const KEY_HOURS = [12, 14, 18, 19, 20, 21];

        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        document.getElementById('startDate').valueAsDate = tomorrow;

        document.getElementById('predictionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const startDate = document.getElementById('startDate').value;
            const horizonDays = parseInt(document.getElementById('horizonDays').value);
            const submitBtn = document.getElementById('submitBtn');
            const loading = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const results = document.getElementById('results');

            submitBtn.disabled = true;
            loading.style.display = 'block';
            errorEl.style.display = 'none';
            results.style.display = 'none';

            try {
                const res = await fetch(`${API_URL}/predict`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        start_date: startDate,
                        horizon_days: horizonDays,
                        include_previous: false
                    }),
                    cache: 'no-store'
                });
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || 'Request failed');
                }
                const data = await res.json();
                displayResults(data);
            } catch (err) {
                errorEl.textContent = err.message;
                errorEl.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                loading.style.display = 'none';
            }
        });

        function displayResults(data) {
            if (comparisonChart) {
                comparisonChart.destroy();
                comparisonChart = null;
            }

            const daily = data.aggregated_daily || [];
            const preds = data.predictions || [];
            const guestPreds = data.guest_predictions || [];

            let dailyCardsHtml = '';
            daily.forEach(day => {
                const shortDate = day.date.slice(5);
                const guestsHtml = day.total_guests != null ? '<div class="guests">' + Math.round(day.total_guests) + ' guests</div>' : '';
                dailyCardsHtml += '<div class="day-card"><div class="date">' + shortDate + '</div><div class="bookings">' + Math.round(day.total_bookings) + '</div><div style="font-size:0.75rem;color:#6b7280">bookings</div>' + guestsHtml + '</div>';
            });

            let keyTimesHtml = '';
            daily.forEach((dayInfo, dayIndex) => {
                const dayLabel = dayIndex === 0 ? 'Day 1' : 'Day ' + (dayIndex + 1);
                const shortDate = dayInfo.date.slice(5);
                let row = '<div class="key-times-day-block"><div class="day-title">' + dayLabel + ' — ' + shortDate + '</div><div class="key-times">';
                KEY_HOURS.forEach(h => {
                    const idx = dayIndex * 24 + h;
                    const val = idx < preds.length ? Math.round(preds[idx]) : '—';
                    const gVal = (guestPreds.length && idx < guestPreds.length) ? Math.round(guestPreds[idx]) : null;
                    const guestHtml = gVal != null ? '<div class="guests">' + gVal + ' guests</div>' : '';
                    row += '<div class="key-time"><div class="label">' + h + ':00</div><div class="value">' + val + '</div><div style="font-size:0.7rem;color:#6b7280">bookings</div>' + guestHtml + '</div>';
                });
                row += '</div></div>';
                keyTimesHtml += row;
            });

            const comparisonLabel = data.comparison_year ? ('Same period (' + data.comparison_year + ')') : 'Same period (history)';

            const resultsEl = document.getElementById('results');
            resultsEl.innerHTML =
                '<h2>Daily forecast</h2>' +
                '<div class="daily-cards" id="dailySummary">' + dailyCardsHtml + '</div>' +
                '<div class="chart-section"><h3>Forecast vs ' + comparisonLabel + '</h3><div id="chartWrapper"></div></div>' +
                '<div class="chart-section"><h3>Key times by day — bookings and head count per hour</h3>' +
                '<p class="section-note">Bookings and guests are historical averages for that weekday and month. Changing the start date changes the forecast.</p>' +
                '<div class="key-times-by-day" id="keyTimesByDay">' + keyTimesHtml + '</div></div>';

            const predDates = daily.map(d => d.date.slice(5));
            const predValues = daily.map(d => Math.round(d.total_bookings));
            const lastYear = data.previous_year_bookings || [];
            const lastYearAligned = predDates.map((_, i) => lastYear[i] != null ? Math.round(lastYear[i]) : null);

            const canvas = document.createElement('canvas');
            canvas.id = 'comparisonChart';
            canvas.height = 220;
            document.getElementById('chartWrapper').appendChild(canvas);
            comparisonChart = new Chart(canvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: predDates,
                    datasets: [
                        { label: 'Forecast', data: predValues, backgroundColor: 'rgba(79, 70, 229, 0.7)', borderColor: 'rgb(79, 70, 229)', borderWidth: 1 },
                        { label: comparisonLabel, data: lastYearAligned, backgroundColor: 'rgba(107, 114, 128, 0.6)', borderColor: 'rgb(107, 114, 128)', borderWidth: 1 }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: true, position: 'top' } },
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'Bookings' } } }
                }
            });

            resultsEl.style.display = 'block';
        }
    </script>
</body>
</html>
